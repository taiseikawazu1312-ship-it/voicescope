generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===== Enum定義 =====
enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum InterviewSessionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum EmotionLabel {
  JOY
  SURPRISE
  INTEREST
  FRUSTRATION
  CONFUSION
  NEUTRAL
}

enum InsightType {
  COMMON_THEME
  OPPOSING_VIEW
  LATENT_NEED
  UNEXPECTED_FINDING
}

// ===== プロジェクト =====
model Project {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      ProjectStatus @default(DRAFT)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  questions  InterviewQuestion[]
  aiSessions AIInterviewSession[]
  insights   Insight[]

  @@index([status])
}

model InterviewQuestion {
  id             String   @id @default(cuid())
  projectId      String
  text           String
  orderIndex     Int
  followUpPrompt String?
  createdAt      DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ===== 回答者・セッション =====
model Respondent {
  id        String   @id @default(cuid())
  name      String?
  email     String?
  metadata  Json?
  createdAt DateTime @default(now())

  aiSessions AIInterviewSession[]

  @@index([email])
}

model AIInterviewSession {
  id           String                 @id @default(cuid())
  projectId    String
  respondentId String
  token        String                 @unique @default(cuid())
  status       InterviewSessionStatus @default(PENDING)
  startedAt    DateTime?
  completedAt  DateTime?
  duration     Int?
  turnCount    Int                    @default(0)
  createdAt    DateTime               @default(now())

  project      Project      @relation(fields: [projectId], references: [id])
  respondent   Respondent   @relation(fields: [respondentId], references: [id])
  transcripts  Transcript[]
  emotions     EmotionDataPoint[]
  qualityScore QualityScore?
  recording    Recording?

  @@index([projectId])
  @@index([respondentId])
  @@index([status])
}

model Recording {
  id        String   @id @default(cuid())
  sessionId String   @unique
  fileUrl   String
  fileSize  Int
  duration  Int
  format    String   @default("webm")
  createdAt DateTime @default(now())

  session AIInterviewSession @relation(fields: [sessionId], references: [id])
}

model Transcript {
  id        String   @id @default(cuid())
  sessionId String
  speaker   String
  text      String
  startTime Float
  endTime   Float
  createdAt DateTime @default(now())

  session AIInterviewSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
}

model EmotionDataPoint {
  id        String       @id @default(cuid())
  sessionId String
  timestamp Float
  emotion   EmotionLabel
  intensity Float
  createdAt DateTime     @default(now())

  session AIInterviewSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
}

model QualityScore {
  id               String   @id @default(cuid())
  sessionId        String   @unique
  overallScore     Float
  specificityScore Float
  depthScore       Float
  consistencyScore Float
  informationScore Float
  uniquenessScore  Float
  summary          String?
  createdAt        DateTime @default(now())

  session AIInterviewSession @relation(fields: [sessionId], references: [id])
}

// ===== 分析 =====
model Insight {
  id          String      @id @default(cuid())
  projectId   String
  type        InsightType
  title       String
  description String
  evidence    Json?
  importance  Float
  createdAt   DateTime    @default(now())

  project Project @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([type])
}
